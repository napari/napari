name: Remove "ready to merge" label

on:
  push:
    branches:
      - main
  schedule:
    - cron: "6 6 * * *" #Â every morning

permissions:
  pull-requests: write

jobs:
  remove_label:
    runs-on: ubuntu-latest
    steps:
      - name: Remove label
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const pulls = await github.rest.pulls.list({
              owner,
              repo,
              state: 'closed',
              per_page: 100,
              sort: 'updated',
              direction: 'desc',
            });
            const labeledPulls = pulls.data.filter(pr =>
              pr.labels.some(label => label.name === 'ready to merge')
            );
            if (labeledPulls.length > 0) {
              console.log('Found the following closed PRs with the "ready to merge" label:');
              for (const pr of labeledPulls) {
                console.log(`- #${pr.number}: ${pr.title}`);
                try {
                  await github.rest.issues.removeLabel({
                    owner,
                    repo,
                    issue_number: pr.number,
                    name: 'ready to merge'
                  });
                  console.log(`  > Removed 'ready to merge' label from #${pr.number}`);
                } catch (error) {
                  console.error(`  > Failed to remove label from #${pr.number}: ${error.message}`);
                }
              }
            } else {
              console.log('No closed PRs found with the "ready to merge" label.');
            }
