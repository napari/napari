version: 2.1
orbs:
  python: circleci/python@1.5.0
jobs:
  build-docs:
    docker:
      - image: cimg/python:3.10.2
    steps:
      - checkout:
          path: napari
      - run:
          name: Clone docs repo into a subdirectory
          command: git clone git@github.com:napari/docs.git docs
      - run:
          name: Install qt libs + xvfb
          command: sudo apt-get update && sudo apt-get install -y xvfb libegl1 libdbus-1-3 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xinput0 libxcb-xfixes0 x11-utils
      - run:
          name: Setup virtual environment
          command: |
            python -m venv venv
            . venv/bin/activate
            python -m pip install --upgrade pip

      - run:
          name: Install napari-dev
          command: |
            . venv/bin/activate
            python -m pip install -e "napari/[pyside,dev]"
          environment:
            PIP_CONSTRAINT: napari/resources/constraints/constraints_py3.10_docs.txt
      - run:
          name: Build docs
          command: |
            . venv/bin/activate
            cd docs
            xvfb-run --auto-servernum make docs GALLERY_PATH=../napari/examples/
          environment:
            PIP_CONSTRAINT: napari/resources/constraints/constraints_py3.10_docs.txt
      - store_artifacts:
          path: docs/_build/
      - persist_to_workspace:
          root: .
          paths:
            - docs/_build/
workflows:
  build-docs:
    jobs:
      - build-docs
